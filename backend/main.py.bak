import json
import os
import time
from functools import wraps
from typing import List, Optional, Dict, Any

from gamechanger_client import GameChangerClient
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

try:
    from gamechanger_client import GameChangerClient
except ImportError:
    GameChangerClient = None

app = FastAPI(title="GameChanger Stats API")

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Simple in-memory cache with TTL
cache_store = {}

def cache_with_ttl(ttl_seconds=300):
    """Cache decorator with time-to-live in seconds"""
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, **kwargs):
            # Create cache key from function name and arguments
            cache_key = f"{func.__name__}:{args}:{kwargs}"
            
            # Check if cache exists and is still valid
            if cache_key in cache_store:
                cached_data, timestamp = cache_store[cache_key]
                if time.time() - timestamp < ttl_seconds:
                    print(f"Cache HIT for {func.__name__}")
                    return cached_data
                else:
                    print(f"Cache EXPIRED for {func.__name__}")
            
            # Cache miss or expired - call function
            print(f"Cache MISS for {func.__name__}")
            result = await func(*args, **kwargs)
            cache_store[cache_key] = (result, time.time())
            return result
        return wrapper
    return decorator


class TeamStats(BaseModel):
    team_name: str
    team_id: str
    stats: dict


class LeagueConfig(BaseModel):
    league_id: str
    season: Optional[str] = None


# Store client instance
gc_client: Optional[GameChangerClient] = None


@app.on_event("startup")
async def startup_event():
    """Initialize the GameChanger client on startup"""
    global gc_client
    if GameChangerClient:
        try:
            # Initialize client with token from environment
            token = os.getenv('GC_TOKEN')
            gc_client = GameChangerClient(token=token)
            print("GameChanger client initialized successfully")
        except Exception as e:
            print(f"Failed to initialize GameChanger client: {e}")


@app.get("/")
async def root():
    return {
        "message": "GameChanger Stats API",
        "client_available": gc_client is not None
    }


@app.get("/api/health")
async def health():
    return {
        "status": "healthy",
        "client_initialized": gc_client is not None
    }


@app.get("/api/organizations")
@cache_with_ttl(ttl_seconds=3600)  # Cache for 1 hour
async def get_organizations():
    """Get all organizations/leagues from teams for the authenticated user"""
    if not gc_client:
        raise HTTPException(status_code=503, detail="GameChanger client not available")
    
    try:
        # Get all teams for the user
        teams = gc_client.me.teams()
        
        # Extract unique organization IDs from teams
        organization_ids = set()
        
        for team in teams:
            # Check if team has organizations
            orgs = team.get('organizations', [])
            if not orgs:
                continue
                
            for org in orgs:
                org_id = org.get('organization_id')
                if org_id and org.get('status') == 'active':
                    organization_ids.add(org_id)
        
        # Fetch full organization details for each unique organization
        org_list = []
        for org_id in organization_ids:
            try:
                org_data = gc_client.organizations.get(org_id)
                
                # Try to fetch avatar image
                avatar_url = None
                try:
                    avatar_data = gc_client.organizations.avatar_image(org_id)
                    print(f"Org {org_id} avatar data: {avatar_data}")
                    avatar_url = avatar_data.get('url') if avatar_data else None
                    print(f"Org {org_id} avatar URL: {avatar_url}")
                except Exception as e:
                    print(f"Error fetching org avatar for {org_id}: {e}")
                    pass  # Avatar is optional
                
                org_list.append({
                    "id": org_data.get('id'),
                    "name": org_data.get('name'),
                    "sport": org_data.get('sport'),
                    "season_name": org_data.get('season_name'),
                    "season_year": org_data.get('season_year'),
                    "city": org_data.get('city'),
                    "state": org_data.get('state'),
                    "type": org_data.get('type'),
                    "avatar_url": avatar_url
                })
            except Exception as e:
                print(f"Error fetching organization {org_id}: {e}")
                continue
        
        # Sort by season year (descending) and name
        org_list.sort(key=lambda x: (-x.get('season_year', 0), x.get('name', '')))
        
        return org_list
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


def aggregate_team_stats(season_stats: Dict[str, Any], stat_type: str) -> Dict[str, Any]:
    """Aggregate player stats to team level"""
    team_stats = {}
    
    players_data = season_stats.get('stats_data', {}).get('players', {})
    
    for player_id, player_data in players_data.items():
        stats = player_data.get('stats', {}).get(stat_type, {})
        
        for stat_key, stat_value in stats.items():
            if stat_key not in team_stats:
                team_stats[stat_key] = 0
            
            # Handle numeric values
            if isinstance(stat_value, (int, float)) and stat_key not in ['AVG', 'OBP', 'OPS', 'SLG', 'ERA', 'WHIP', 'BAA', 'S%']:
                team_stats[stat_key] += stat_value
    
    return team_stats


def format_stat(value, decimal_places=3):
    """Format a stat value for display"""
    if value is None:
        return "0"
    if isinstance(value, float):
        return f"{value:.{decimal_places}f}"
    return str(value)


@app.get("/api/stats/{organization_id}")
@cache_with_ttl(ttl_seconds=600)  # Cache for 10 minutes
async def get_all_stats(organization_id: str):
    """Get all batting, pitching, and fielding statistics for all players in an organization"""
    if not gc_client:
        raise HTTPException(status_code=503, detail="GameChanger client not available")
    
    try:
        # Get all teams in the organization
        teams_data = gc_client.organizations.teams(organization_id=organization_id)
        
        batting_stats = []
        pitching_stats = []
        fielding_stats = []
        
        for team in teams_data:
            team_id = team.get('root_team_id')
            team_name = team.get('name', 'Unknown Team')
            team_public_id = team.get('team_public_id')
            
            if not team_id:
                continue
            
            # Get team avatar
            team_avatar = None
            try:
                avatar_data = gc_client.teams.avatar_image(team_id)
                team_avatar = avatar_data.get('url') if avatar_data else None
            except:
                pass
            
            try:
                # Get season stats for the team (single API call)
                season_stats = gc_client.teams.season_stats(team_id)
                
                # Get players for the team
                try:
                    players = gc_client.teams.public_players(team_public_id) if team_public_id else []
                except:
                    players = []
                
                # Create player lookup map
                player_map = {p.get('id'): p for p in players}
                
                # Extract individual player stats
                players_data = season_stats.get('stats_data', {}).get('players', {})
                
                for player_id, player_data in players_data.items():
                    player_info = player_map.get(player_id, {})
                    player_name = f"{player_info.get('first_name', '')} {player_info.get('last_name', '')}".strip()
                    
                    # Skip unknown players
                    if not player_name or 'unknown' in player_name.lower():
                        continue
                    
                    # Process batting (offense) stats
                    offense_stats = player_data.get('stats', {}).get('offense', {})
                    if offense_stats:
                        ab = offense_stats.get('AB', 0)
                        h = offense_stats.get('H', 0)
                        avg = (h / ab) if ab > 0 else 0
                        
                        bb = offense_stats.get('BB', 0)
                        hbp = offense_stats.get('HBP', 0)
                        sf = offense_stats.get('SF', 0)
                        pa = ab + bb + hbp + sf
                        obp = ((h + bb + hbp) / pa) if pa > 0 else 0
                        
                        singles = offense_stats.get('1B', 0)
                        doubles = offense_stats.get('2B', 0)
                        triples = offense_stats.get('3B', 0)
                        hr = offense_stats.get('HR', 0)
                        total_bases = singles + (doubles * 2) + (triples * 3) + (hr * 4)
                        slg = (total_bases / ab) if ab > 0 else 0
                        
                        batting_stats.append({
                            "player_name": player_name,
                            "player_number": player_info.get('number', ''),
                            "player_id": player_id,
                            "team_name": team_name,
                            "team_id": team_id,
                            "team_avatar": team_avatar,
                            "games": offense_stats.get('GP', 0),
                            "at_bats": ab,
                            "hits": h,
                            "doubles": doubles,
                            "triples": triples,
                            "home_runs": hr,
                            "rbi": offense_stats.get('RBI', 0),
                            "walks": bb,
                            "strikeouts": offense_stats.get('SO', 0),
                            "batting_avg": format_stat(avg),
                            "on_base_pct": format_stat(obp),
                            "slugging_pct": format_stat(slg)
                        })
                    
                    # Process pitching (defense) stats
                    defense_stats = player_data.get('stats', {}).get('defense', {})
                    if defense_stats:
                        ip = defense_stats.get('IP', 0)
                        er = defense_stats.get('ER', 0)
                        era = ((er * 7) / ip) if ip > 0 else 0
                        
                        h = defense_stats.get('H', 0)
                        bb = defense_stats.get('BB', 0)
                        whip = ((h + bb) / ip) if ip > 0 else 0
                        
                        pitching_stats.append({
                            "player_name": player_name,
                            "player_number": player_info.get('number', ''),
                            "player_id": player_id,
                            "team_name": team_name,
                            "team_id": team_id,
                            "team_avatar": team_avatar,
                            "games": defense_stats.get('GP', 0),
                            "innings_pitched": ip,
                            "hits_allowed": h,
                            "runs_allowed": defense_stats.get('R', 0),
                            "earned_runs": er,
                            "walks": bb,
                            "strikeouts": defense_stats.get('SO', 0),
                            "era": format_stat(era, 2),
                            "whip": format_stat(whip, 2),
                            "wins": 0,
                            "losses": 0
                        })
                        
                        # Fielding stats (also from defense)
                        po = defense_stats.get('PO', 0)
                        a = defense_stats.get('A', 0)
                        e = defense_stats.get('E', 0)
                        chances = po + a + e
                        fpct = ((po + a) / chances) if chances > 0 else 0
                        
                        fielding_stats.append({
                            "player_name": player_name,
                            "player_number": player_info.get('number', ''),
                            "player_id": player_id,
                            "team_name": team_name,
                            "team_id": team_id,
                            "team_avatar": team_avatar,
                            "games": defense_stats.get('GP', 0),
                            "putouts": po,
                            "assists": a,
                            "errors": e,
                            "double_plays": defense_stats.get('DP', 0),
                            "fielding_pct": format_stat(fpct)
                        })
                
            except Exception as e:
                print(f"Error getting stats for team {team_name}: {e}")
                continue
        
        return {
            "batting": batting_stats,
            "pitching": pitching_stats,
            "fielding": fielding_stats
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/batting/{organization_id}")
@cache_with_ttl(ttl_seconds=600)  # Cache for 10 minutes
async def get_batting_stats(organization_id: str):
    """Get batting statistics for all players in an organization"""
    if not gc_client:
        raise HTTPException(status_code=503, detail="GameChanger client not available")
    
    try:
        # Get all teams in the organization
        teams_data = gc_client.organizations.teams(organization_id=organization_id)
        
        all_stats = []
        
        for team in teams_data:
            team_id = team.get('root_team_id')
            team_name = team.get('name', 'Unknown Team')
            team_public_id = team.get('team_public_id')
            
            if not team_id:
                continue
            
            # Get team avatar
            team_avatar = None
            try:
                avatar_data = gc_client.teams.avatar_image(team_id)
                team_avatar = avatar_data.get('url') if avatar_data else None
            except:
                pass
            
            try:
                # Get season stats for the team
                season_stats = gc_client.teams.season_stats(team_id)
                
                # Get players for the team
                try:
                    players = gc_client.teams.public_players(team_public_id) if team_public_id else []
                except:
                    players = []
                
                # Create player lookup map
                player_map = {p.get('id'): p for p in players}
                
                # Extract individual player stats
                players_data = season_stats.get('stats_data', {}).get('players', {})
                
                for player_id, player_data in players_data.items():
                    player_info = player_map.get(player_id, {})
                    player_stats = player_data.get('stats', {}).get('offense', {})
                    
                    if not player_stats:
                        continue
                    
                    # Calculate derived stats
                    ab = player_stats.get('AB', 0)
                    h = player_stats.get('H', 0)
                    avg = (h / ab) if ab > 0 else 0
                    
                    bb = player_stats.get('BB', 0)
                    hbp = player_stats.get('HBP', 0)
                    sf = player_stats.get('SF', 0)
                    pa = ab + bb + hbp + sf
                    obp = ((h + bb + hbp) / pa) if pa > 0 else 0
                    
                    singles = player_stats.get('1B', 0)
                    doubles = player_stats.get('2B', 0)
                    triples = player_stats.get('3B', 0)
                    hr = player_stats.get('HR', 0)
                    total_bases = singles + (doubles * 2) + (triples * 3) + (hr * 4)
                    slg = (total_bases / ab) if ab > 0 else 0
                    
                    player_name = f"{player_info.get('first_name', '')} {player_info.get('last_name', '')}".strip()
                    
                    # Skip unknown players
                    if not player_name or 'unknown' in player_name.lower():
                        continue
                    
                    batting_stat = {
                        "player_name": player_name,
                        "player_number": player_info.get('number', ''),
                        "player_id": player_id,
                        "team_name": team_name,
                        "team_id": team_id,
                        "team_avatar": team_avatar,
                        "games": player_stats.get('GP', 0),
                        "at_bats": ab,
                        "hits": h,
                        "doubles": doubles,
                        "triples": triples,
                        "home_runs": hr,
                        "rbi": player_stats.get('RBI', 0),
                        "walks": bb,
                        "strikeouts": player_stats.get('SO', 0),
                        "batting_avg": format_stat(avg),
                        "on_base_pct": format_stat(obp),
                        "slugging_pct": format_stat(slg)
                    }
                    
                    all_stats.append(batting_stat)
                
            except Exception as e:
                print(f"Error getting stats for team {team_name}: {e}")
                continue
        
        return all_stats
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/pitching/{organization_id}")
@cache_with_ttl(ttl_seconds=600)  # Cache for 10 minutes
async def get_pitching_stats(organization_id: str):
    """Get pitching statistics for all players in an organization"""
    if not gc_client:
        raise HTTPException(status_code=503, detail="GameChanger client not available")
    
    try:
        # Get all teams in the organization
        teams_data = gc_client.organizations.teams(organization_id=organization_id)
        
        all_stats = []
        
        for team in teams_data:
            team_id = team.get('root_team_id')
            team_name = team.get('name', 'Unknown Team')
            team_public_id = team.get('team_public_id')
            
            if not team_id:
                continue
            
            # Get team avatar
            team_avatar = None
            try:
                avatar_data = gc_client.teams.avatar_image(team_id)
                team_avatar = avatar_data.get('url') if avatar_data else None
            except:
                pass
            
            try:
                # Get season stats for the team
                season_stats = gc_client.teams.season_stats(team_id)
                
                # Get players for the team
                try:
                    players = gc_client.teams.public_players(team_public_id) if team_public_id else []
                except:
                    players = []
                
                # Create player lookup map
                player_map = {p.get('id'): p for p in players}
                
                # Extract individual player stats
                players_data = season_stats.get('stats_data', {}).get('players', {})
                
                for player_id, player_data in players_data.items():
                    player_info = player_map.get(player_id, {})
                    player_stats = player_data.get('stats', {}).get('defense', {})
                    
                    if not player_stats:
                        continue
                    
                    # Calculate derived stats
                    ip = player_stats.get('IP', 0)
                    er = player_stats.get('ER', 0)
                    era = ((er * 7) / ip) if ip > 0 else 0
                    
                    h = player_stats.get('H', 0)
                    bb = player_stats.get('BB', 0)
                    whip = ((h + bb) / ip) if ip > 0 else 0
                    
                    # Get player avatar
                    player_avatar = None
                    try:
                        avatar_data = gc_client.players.avatar_image(player_id)
                        player_avatar = avatar_data.get('url') if avatar_data else None
                    except:
                        pass
                    
                    player_name = f"{player_info.get('first_name', '')} {player_info.get('last_name', '')}".strip()
                    
                    # Skip unknown players
                    if not player_name or 'unknown' in player_name.lower():
                        continue
                    
                    pitching_stat = {
                        "player_name": player_name,
                        "player_number": player_info.get('number', ''),
                        "player_id": player_id,
                        "team_name": team_name,
                        "team_id": team_id,
                        "team_avatar": team_avatar,
                        "games": player_stats.get('GP', 0),
                        "innings_pitched": ip,
                        "hits_allowed": h,
                        "runs_allowed": player_stats.get('R', 0),
                        "earned_runs": er,
                        "walks": bb,
                        "strikeouts": player_stats.get('SO', 0),
                        "era": format_stat(era, 2),
                        "whip": format_stat(whip, 2),
                        "wins": 0,  # Individual player wins not typically tracked
                        "losses": 0
                    }
                    
                    all_stats.append(pitching_stat)
                
            except Exception as e:
                print(f"Error getting pitching stats for team {team_name}: {e}")
                continue
        
        return all_stats
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@app.get("/api/fielding/{organization_id}")
@cache_with_ttl(ttl_seconds=600)  # Cache for 10 minutes
async def get_fielding_stats(organization_id: str):
    """Get fielding statistics for all players in an organization"""
    if not gc_client:
        raise HTTPException(status_code=503, detail="GameChanger client not available")
    
    try:
        # Get all teams in the organization
        teams_data = gc_client.organizations.teams(organization_id=organization_id)
        
        all_stats = []
        
        for team in teams_data:
            team_id = team.get('root_team_id')
            team_name = team.get('name', 'Unknown Team')
            team_public_id = team.get('team_public_id')
            
            if not team_id:
                continue
            
            # Get team avatar
            team_avatar = None
            try:
                avatar_data = gc_client.teams.avatar_image(team_id)
                team_avatar = avatar_data.get('url') if avatar_data else None
            except:
                pass
            
            try:
                # Get season stats for the team
                season_stats = gc_client.teams.season_stats(team_id)
                
                # Get players for the team
                try:
                    players = gc_client.teams.public_players(team_public_id) if team_public_id else []
                except:
                    players = []
                
                # Create player lookup map
                player_map = {p.get('id'): p for p in players}
                
                # Extract individual player stats
                players_data = season_stats.get('stats_data', {}).get('players', {})
                
                for player_id, player_data in players_data.items():
                    player_info = player_map.get(player_id, {})
                    player_stats = player_data.get('stats', {}).get('defense', {})
                    
                    if not player_stats:
                        continue
                    
                    # Calculate fielding percentage
                    po = player_stats.get('PO', 0)
                    a = player_stats.get('A', 0)
                    e = player_stats.get('E', 0)
                    chances = po + a + e
                    fpct = ((po + a) / chances) if chances > 0 else 0
                    
                    # Get player avatar
                    player_avatar = None
                    try:
                        avatar_data = gc_client.players.avatar_image(player_id)
                        player_avatar = avatar_data.get('url') if avatar_data else None
                    except:
                        pass
                    
                    player_name = f"{player_info.get('first_name', '')} {player_info.get('last_name', '')}".strip()
                    
                    # Skip unknown players
                    if not player_name or 'unknown' in player_name.lower():
                        continue
                    
                    fielding_stat = {
                        "player_name": player_name,
                        "player_number": player_info.get('number', ''),
                        "player_id": player_id,
                        "team_name": team_name,
                        "team_id": team_id,
                        "team_avatar": team_avatar,
                        "games": player_stats.get('GP', 0),
                        "putouts": po,
                        "assists": a,
                        "errors": e,
                        "double_plays": player_stats.get('DP', 0),
                        "fielding_pct": format_stat(fpct)
                    }
                    
                    all_stats.append(fielding_stat)
                
            except Exception as e:
                print(f"Error getting fielding stats for team {team_name}: {e}")
                continue
        
        return all_stats
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)

